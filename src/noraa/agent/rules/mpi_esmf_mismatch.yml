id: mpi-esmf-mismatch
title: ESMF and MPAS built against different MPI stacks
severity: error
match_any_regex:
  - "undefined reference to .*ompi_"
  - "undefined reference to ompi_"
  - "ompi_op_set_cxx_callback"
  - "ompi_mpi_errors_throw_exceptions"
  - "libmpi_cxx\\.so"
summary: >
  The build is mixing two different Open MPI runtimes (often system Open MPI vs deps Open MPI).
likely_cause: >
  ESMF was built or linked against a different MPI than the MPI wrappers used for the ufsatm MPAS build.
evidence_commands:
  - "which mpicc mpifort mpiexec || true"
  - "mpiexec --version || true"
  - "echo DEPS_PREFIX=$DEPS_PREFIX"
  - "echo ESMFMKFILE=$ESMFMKFILE"
  - "ldd {mpas_exe} | grep -E 'libmpi|open-pal|pmix|open-rte' || true"
fix_steps:
  - "export DEPS_PREFIX={deps_prefix}"
  - "export PATH=\"$DEPS_PREFIX/bin:$PATH\""
  - "export LD_LIBRARY_PATH=\"$DEPS_PREFIX/lib:$DEPS_PREFIX/lib64:${LD_LIBRARY_PATH:-}\""
  - "# Rebuild ESMF against the same MPI stack, install to a fresh prefix"
  - "export ESMF_SRC=\"$HOME/opt/esmf-8.6.1\""
  - "export ESMF_INSTALL_PREFIX=\"$HOME/opt/esmf-install-ompi5\""
  - "cd \"$ESMF_SRC\""
  - "make distclean || true"
  - "make -j$(nproc) && make install"
  - "export ESMFMKFILE=\"$ESMF_INSTALL_PREFIX/lib/libO/Linux.gfortran.64.openmpi.default/esmf.mk\""
  - "# Re-run verify"
  - "cd {repo_root}"
  - "rm -rf .noraa/build"
  - "DEPS_PREFIX=\"$DEPS_PREFIX\" ESMFMKFILE=\"$ESMFMKFILE\" bash scripts/verify_mpas_smoke.sh"
